from base64 import b64encode
from fman.impl.licensing import LicenseManager, _negate, decrypt
from rsa import PrivateKey
from unittest import TestCase

import json
import rsa

class LicenseManagerTest(TestCase):
	def test_no_email(self):
		lm = LicenseManager('0.2.9', '', '')
		self.assertFalse(lm.is_licensed())
	def test_no_key(self):
		lm = LicenseManager('0.2.9', 'michael@herrmann.io', '')
		self.assertFalse(lm.is_licensed())
	def test_is_licensed(self):
		email = 'michael@herrmann.io'
		lm = LicenseManager('0.2.9', email, generate_key(email))
		self.assertTrue(lm.is_licensed())
	def test_max_version(self):
		is_licensed = self._versioncheck(version='0.2.8', max_version='0.2.9')
		self.assertTrue(is_licensed)
	def test_max_version_false(self):
		is_licensed = self._versioncheck(version='0.3.0', max_version='0.2.9')
		self.assertFalse(is_licensed)
	def _versioncheck(self, version, max_version):
		email = 'michael@herrmann.io'
		lm = LicenseManager(version, email, generate_key(email, max_version))
		return lm.is_licensed()

class EncryptionTest(TestCase):
	def test_simple(self):
		text = '{"email": "michael@herrmann.io"}' * 1000
		self.assertEqual(text, decrypt(encrypt(text)))

def generate_key(email, max_version=None):
	data = {
		'email': email
	}
	if max_version:
		data['max_version'] = max_version
	return pack_key(data)

def pack_key(data):
	return encrypt(json.dumps(data))

def encrypt(text):
	bytes_ = text.encode('utf-8')
	bytes_negated = _negate(bytes_)
	signature = rsa.sign(bytes_negated, _SIGN_PRIV_KEY, 'SHA-1')
	return b64encode(signature + bytes_negated).decode('ascii')

_SIGN_PRIV_KEY = PrivateKey(146142096601994918206700648259140200952100463274320504063611160294570078501586995967016070398912575192277695142590132973263670517442427130500485732664894774182275447661818963467005949739008288209651168713547437071057019064692363086596546730713984877667901498460512867391678806498712503463981815559532208736523, 65537, 106496395158735879025826778149137398981802858309885997727542331711065166380499439299826868640787139570514337925443941140685816814501967360398586982170748237192314350435576220165300696469415364990182400579393918168894154764719809140330404245768708165575118557585084513541133385899426977724563946441819272561953, 53814768570805402343382108978014344824260175208379647909206093545673396247171146482415406423611088539769948553707220783902125888028734883241844600109457389608612643, 2715650377827272462961221898973150292742268179788405438319789816103372507158845181548791073053845916750266308833132757067659526868002609335207161)